//////////////////////////////////////////////////////////////////////////////////
// CloudCarousel V1.0.5
// (c) 2011 by R Cecco. <http://www.professorcloud.com>
// MIT License
//
// Reflection code based on plugin by Christophe Beyls <http://www.digitalia.be>
//
// Please retain this copyright header in all versions of the software
//////////////////////////////////////////////////////////////////////////////////
(function(e){function t(t,n,r){var i,s,o=t.width,u=t.width,a,f;f=e(t.parentNode);this.element=i=f.append("<canvas class='reflection' style='position:absolute'/>").find(":last")[0];if(!i.getContext&&e.browser.msie){this.element=i=f.append("<img class='reflection' style='position:absolute'/>").find(":last")[0];i.src=t.src;i.style.filter="flipv progid:DXImageTransform.Microsoft.Alpha(opacity="+r*100+", style=1, finishOpacity=0, startx=0, starty=0, finishx=0, finishy="+n/u*100+")"}else{s=i.getContext("2d");try{e(i).attr({width:o,height:n});s.save();s.translate(0,u-1);s.scale(1,-1);s.drawImage(t,0,0,o,u);s.restore();s.globalCompositeOperation="destination-out";a=s.createLinearGradient(0,0,0,n);a.addColorStop(0,"rgba(255, 255, 255, "+(1-r)+")");a.addColorStop(1,"rgba(255, 255, 255, 1.0)");s.fillStyle=a;s.fillRect(0,0,o,n)}catch(l){return}}e(i).attr({alt:e(t).attr("alt"),title:e(t).attr("title")})}var n=function(n,r){this.orgWidth=n.width;this.orgHeight=n.height;this.image=n;this.reflection=null;this.alt=n.alt;this.title=n.title;this.imageOK=!1;this.options=r;this.imageOK=!0;this.options.reflHeight>0&&(this.reflection=new t(this.image,this.options.reflHeight,this.options.reflOpacity));e(this.image).css("position","absolute")},r=function(t,r,i){var s=[],o=Math.sin,u=Math.cos,a=this;this.controlTimer=0;this.stopped=!1;this.container=t;this.xRadius=i.xRadius;this.yRadius=i.yRadius;this.showFrontTextTimer=0;this.autoRotateTimer=0;i.xRadius===0&&(this.xRadius=e(t).width()/2.3);i.yRadius===0&&(this.yRadius=e(t).height()/6);this.xCentre=i.xPos;this.yCentre=i.yPos;this.frontIndex=0;this.rotation=this.destRotation=Math.PI/2;this.timeDelay=1e3/i.FPS;if(i.altBox!==null){e(i.altBox).css("display","block");e(i.titleBox).css("display","block")}e(i.buttonLeft).css("display","inline");e(i.buttonRight).css("display","inline");e(i.buttonLeft).bind("mouseup",this,function(e){e.data.rotate(-1);return!1});e(i.buttonRight).bind("mouseup",this,function(e){e.data.rotate(1);return!1});i.mouseWheel&&e(t).bind("mousewheel",this,function(e,t){e.data.rotate(t);return!1});e(t).bind("mouseover click",this,function(t){clearInterval(t.data.autoRotateTimer);var n=e(t.target).attr("alt");if(n!==undefined&&n!==null){clearTimeout(t.data.showFrontTextTimer);e(i.altBox).html(e(t.target).attr("alt"));e(i.titleBox).html(e(t.target).attr("title"));if(i.bringToFront&&t.type=="click"){var s=e(t.target).data("itemIndex"),o=t.data.frontIndex,u=(s-o)%r.length;Math.abs(u)>r.length/2&&(u+=u>0?-r.length:r.length);t.data.rotate(-u)}}});e(t).bind("mouseout",this,function(e){var t=e.data;clearTimeout(t.showFrontTextTimer);t.showFrontTextTimer=setTimeout(function(){t.showFrontText()},1e3);t.autoRotate()});e(t).bind("mousedown",this,function(e){e.data.container.focus();return!1});t.onselectstart=function(){return!1};this.innerWrapper=e(t).wrapInner('<div style="position:absolute;width:100%;height:100%;"/>').children()[0];this.showFrontText=function(){if(s[this.frontIndex]===undefined)return;e(i.titleBox).html(e(s[this.frontIndex].image).attr("title"));e(i.altBox).html(e(s[this.frontIndex].image).attr("alt"))};this.go=function(){if(this.controlTimer!==0)return;var e=this;this.controlTimer=setTimeout(function(){e.updateAll()},this.timeDelay)};this.stop=function(){clearTimeout(this.controlTimer);this.controlTimer=0};this.rotate=function(e){this.frontIndex-=e;this.frontIndex%=s.length;this.destRotation+=Math.PI/s.length*2*e;this.showFrontText();this.go()};this.autoRotate=function(){if(i.autoRotate!=="no"){var e=i.autoRotate==="right"?1:-1;this.autoRotateTimer=setInterval(function(){a.rotate(e)},i.autoRotateDelay)}};this.updateAll=function(){var t=i.minScale,n=(1-t)*.5,r,a,f,l,c,h,p,d=this.destRotation-this.rotation,v=Math.abs(d);this.rotation+=d*i.speed;v<.001&&(this.rotation=this.destRotation);var m=s.length,g=Math.PI/m*2,y=this.rotation,b=e.browser.msie;this.innerWrapper.style.display="none";var w,E="px",S,x=this;for(var T=0;T<m;T++){h=s[T];p=o(y);c=(p+1)*n+t;f=this.xCentre+(u(y)*this.xRadius-h.orgWidth*.5)*c;l=this.yCentre+p*this.yRadius*c;if(h.imageOK){var N=h.image;r=N.width=h.orgWidth*c;a=N.height=h.orgHeight*c;N.style.left=f+E;N.style.top=l+E;N.style.zIndex=""+c*100>>0;if(h.reflection!==null){S=i.reflHeight*c;w=h.reflection.element.style;w.left=f+E;w.top=l+a+i.reflGap*c+E;w.width=r+E;b?w.filter.finishy=S/a*100:w.height=S+E}}y+=g}this.innerWrapper.style.display="block";v>=.001?this.controlTimer=setTimeout(function(){x.updateAll()},this.timeDelay):this.stop()};this.checkImagesLoaded=function(){var t;for(t=0;t<r.length;t++)if(r[t].width===undefined||r[t].complete!==undefined&&!r[t].complete)return;for(t=0;t<r.length;t++){s.push(new n(r[t],i));e(r[t]).data("itemIndex",t)}clearInterval(this.tt);this.showFrontText();this.autoRotate();this.updateAll()};this.tt=setInterval(function(){a.checkImagesLoaded()},50)};e.fn.CloudCarousel=function(t){this.each(function(){t=e.extend({},{reflHeight:0,reflOpacity:.5,reflGap:0,minScale:.5,xPos:0,yPos:0,xRadius:0,yRadius:0,altBox:null,titleBox:null,FPS:30,autoRotate:"no",autoRotateDelay:1500,speed:.2,mouseWheel:!1,bringToFront:!1},t);e(this).data("cloudcarousel",new r(this,e(".cloudcarousel",e(this)),t))});return this}})(jQuery);